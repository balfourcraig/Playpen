<!DOCTYPE html>
<html lang="en-nz">
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta charset="UTF-8">
	<title>Theramin - Craig's Playpen</title>
	<link rel="stylesheet" href="../css/styles.css">
	<link rel="shortcut icon" type="image/x-icon" href="../favicon.ico" />
	<script>
		const golden_ratio= 0.618033988749895;
		let randh = Math.random();
		let w = 0;
		let osc;
		let gainNode;
		let mousePosArr = [];
		let started = false;
		let ctx;
		
		function shuffleInplace(arr){
			let n = arr.length;
			while(n > 0){
				const r = Math.floor(Math.random() * n);
				const temp = arr[r];
				arr[r] = arr[n-1];
				arr[n-1] = temp;
				n--;
			}
		}

		function setUp(){
			started = true;
			w = document.getElementById('sizeCalc').getBoundingClientRect().width;
			console.log('setup');
			const c = document.createElement('canvas');
			c.id = 'pieCanvas';
			c.setAttribute('width', w);
			c.setAttribute('height', w);
			ctx = c.getContext('2d');
			const canvResult = document.getElementById('canvResult');
			canvResult.innerHTML = '';
			canvResult.appendChild(c);
			
			mousePosArr = [];
			const aCtx = new AudioContext(); 
			
			gainNode = aCtx.createGain();
			gainNode.gain.value = 0.3;
			gainNode.connect(aCtx.destination);
			

			osc = aCtx.createOscillator();
			osc.frequency.value = 0;
			osc.type = 'sine';
			osc.connect(gainNode);
			osc.start();
			
			canvResult.addEventListener('mousemove', drawPattern);
			canvResult.addEventListener('touchmove', drawPattern);
			
			document.getElementById('startBtn').style.display = 'none';
			document.getElementById('stopDrawingBtn').style.display = 'block';
			drawPattern();
		}

		function drawPattern(e){
			const showBackColor = document.getElementById('backColorInput').checked;
			const baseFreq = Math.max(100, Math.min(20000, parseInt(document.getElementById('baseFreqInput').value)));
			const maxTrails = Math.max(0, parseInt(document.getElementById('maxTrailsInput').value));
			const trailWidth = Math.max(1, parseInt(document.getElementById('lineWidthInput').value));
			const gridLines = Math.max(0, parseInt(document.getElementById('gridLinesInput').value));
			const showLines = document.getElementById('showLinesInput').checked && maxTrails > 0;
			const waveType = document.getElementById('waveTypeSelect').value;
			const baseVolume = Math.max(0, Math.min(100, parseInt(document.getElementById('baseVolumeInput').value))) / 100;
			
			if(waveType != osc.type)
				osc.type = waveType;
			
			if(started){
				ctx.strokeStyle = 'black';
				const c = document.getElementById('pieCanvas');

				const rect = c.getBoundingClientRect();

				if(e) {
					const mouseX = e.clientX - rect.left;
					const mouseY = e.clientY - rect.top;
					
					const xMapped = (0.9 * Math.pow(mouseX / rect.width, 1.5)) + 0.1;
					const yMapped = mouseY / rect.height;
					
					let color = 'white';
					if(showBackColor){
						color = 'hsl(' + (xMapped * 220) + ',' + (yMapped * 100) + '%,50%)';
					}
					ctx.fillStyle = color;
					ctx.fillRect(0,0,w,w);
					
					osc.frequency.value = xMapped * baseFreq;
					gainNode.gain.value = yMapped * baseVolume;
					const mousePoint = {x:mouseX, y:mouseY};
					
					if(showLines){
						if(mousePosArr.length < maxTrails){
							mousePosArr.unshift(mousePoint);
						}
						else{
							for(let i = Math.min(mousePosArr.length -1, maxTrails); i > 0; i--){
								mousePosArr[i] = mousePosArr[i-1];
							}
							mousePosArr[0] = mousePoint;
						}

						if(mousePosArr.length > 1 && maxTrails > 1){
							ctx.lineWidth = trailWidth;
							for(let i = 1; i < Math.min(mousePosArr.length, maxTrails); i++){
								const grad = ctx.createLinearGradient(mousePosArr[0].x, mousePosArr[0].y, mousePosArr[i].x, mousePosArr[i].y);
								grad.addColorStop(1, 'rgba(255,255,255,0)');
								grad.addColorStop(0.2, 'hsla(' + (i/Math.min(mousePosArr.length, maxTrails) * 360) + ',90%,50%,' + (i/Math.min(mousePosArr.length, maxTrails)) + ')');
								grad.addColorStop(0, 'rgba(255,255,255,0)');
								ctx.strokeStyle = grad;
								
								ctx.beginPath();
								ctx.moveTo(mousePosArr[0].x, mousePosArr[0].y);
								ctx.lineTo(mousePosArr[i].x, mousePosArr[i].y);
								ctx.stroke();
							}
							ctx.lineWidth = 1;
						}
					}
					
					drawCircle(ctx, mousePoint, trailWidth * 1.5, 'dodgerblue');
				}
				else{
					ctx.fillStyle = 'white';
					ctx.fillRect(0,0,w,w);
				}
				ctx.strokeStyle = 'black';
				ctx.strokeRect(0,0,w,w);
				if(gridLines > 0){
					drawGrid(ctx, w,w,gridLines,gridLines);
				}
				
			}
		}
		
		function drawGrid(ctx, w, h, numColumns, numRows){
			const oldStrokeStyle = ctx.strokeStyle;
			ctx.strokeStyle = 'black';
			for(let i = 1; i < numColumns; i++){
				ctx.beginPath();
				const xPoint = (w/numColumns) * i;
				ctx.moveTo(xPoint, 0);
				ctx.lineTo(xPoint, h);
				ctx.stroke();
			}
			for(let i = 1; i < numColumns; i++){
				ctx.beginPath();
				const yPoint = (h/numRows) * i;
				ctx.moveTo(0, yPoint);
				ctx.lineTo(w, yPoint);
				ctx.stroke();
			}
			ctx.strokeStyle = oldStrokeStyle;
		}

		function drawCircle(ctx, center, radius, color){
			ctx.fillStyle = color;
			
			ctx.beginPath();
			ctx.arc(center.x, center.y, radius, 0, 2 * Math.PI);
			ctx.fill();
		}

		window.addEventListener('DOMContentLoaded', () => {
			document.getElementById('startBtn').addEventListener('click', setUp);
			document.getElementById('stopDrawingBtn').addEventListener('click', () => {
				osc.stop();
				started = false;
				ctx.fillStyle = 'white';
				ctx.fillRect(0,0,w,w);
				document.getElementById('stopDrawingBtn').style.display = 'none';
				document.getElementById('startBtn').style.display = 'block';
			});
		});
	</script>
	
</head>
<body>
<div class="navHolder">
	<nav>
		<a href="../index.html">Home</a>
		<a class="selected" href="../ramblings.html">Deranged Ramblings</a>
		<a href="../about.html">About</a>
	</nav>
</div>

<main>
	<div class="pageWidth">
		<header>
			<h1>Digital Theramin</h1>
			<h2>Now with your daily recommended dose of psychedlic funk!</h2>
		</header>
		<section>
			<p>Y-Axix is volume, X-Axis is frequency</p>
			<p>Move mouse around on desktop. Tap areas on phone</p>
			<div class="optionsArea">
				<div class="op">
					<input id="backColorInput" type="checkbox">
					<label for="backColorInput">Show Background Color</label>
				</div>
				<div class="op">
					<input id="showLinesInput" type="checkbox" checked>
					<label for="showLinesInput">Show Lines</label>
				</div>
				<div class="op">
					<input id="baseFreqInput" type="number" value="1000" min="100" max="20000" step="100">
					<label for="baseFreqInput">Base Frequency (Hz)</label>
				</div>
				<div class="op">
					<input id="baseVolumeInput" type="number" value="50" min="0" max="100">
					<label for="baseVolumeInput">Base Volume %</label>
				</div>
				<div class="op">
					<input id="maxTrailsInput" type="number" value="60" min="0">
					<label for="maxTrailsInput">Max trails</label>
				</div>
				<div class="op">
					<input id="lineWidthInput" type="number" value="5" min="1">
					<label for="lineWidthInput">Trail Width</label>
				</div>
				<div class="op">
					<input id="gridLinesInput" type="number" value="0" min="0">
					<label for="gridLinesInput">Grid Lines</label>
				</div>
				<div class="op">
					<select id="waveTypeSelect">
						<option value="sine" selected>Sine wave</option>
						<option value="sawtooth">Sawtooth</option>
						<option value="square">Square</option>
						<option value="triangle">Triangle</option>
					</select>
					<label for="waveTypeSelect">Waveform type</label>
				</div>
			</div>
			<button id="startBtn">START &#x1f50a;</button>
			<button id="stopDrawingBtn" style="display:none">STOP &#x1f507;</button>
			<div id="sizeCalc"></div>
			<img id="modMulResult">
			<div id="canvResult"></div>
		</section>
		<div class="scrollOverflow"></div>
	</div>
</main>
</body>
</html>